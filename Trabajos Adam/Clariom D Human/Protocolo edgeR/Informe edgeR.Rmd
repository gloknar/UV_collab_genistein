---
title: "Análisis de microarrays _Clariom D Human_ en `edgeR`"
author: "Adam Casas"
date: 'Compilado: `r format(Sys.Date(), "%d de %B del %Y")`'
output: 
  html_document:
    df_print: paged
    highlight: kate
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: yes
---

```{r configuracion inicial, include=FALSE}
##################################################
#######        Encoded in UTF-8        ###########
##################################################

# Establecemos la configuración de los chunks
knitr::opts_chunk$set(echo = T,
                      message = F,
                      warning = F,
                      tidy = F)
set.seed(1)
```

***

# Introducción

Este documento es una continuación del protocolo `limma` en el paquete `edgeR` y por tanto podemos omitir el control de calidad de las muestras. El raciocinio detrás de este informe es analizar nuestros microarrays de ARNm en varios paquetes para posteriormente cruzar los resultados mediante diagramas de Venn.

De acuerdo a sus [creadores](http://www.bioconductor.org/packages/release/bioc/vignettes/edgeR/inst/doc/edgeRUsersGuide.pdf), `edgeR` es un paquete diseñado para el análisis DEG de muestras de tanto RNA-Seq como ChIP-Seq, Hi-C Seq, SAGE-Seq y _screens_ genéticos con CRISPR-Cas9, entre otros.



<br>

***

# Carga de datos y librerías

Primero debemos instalar `edgeR`. Puesto que usamos R 3.6, instalaremos la versión 1.50.0 de `oligo`, el cual depende de los paquetes `ff` versión 2.2.0 y `RSQLite` versión 2.1.4. Instalar versiones posteriores ocasionará fallos en la carga de `oligo` y en los análisis posteriores:

```{r instalacion edgeR y dependencias, eval = F}
# Instalación edgeR en R 3.6:
BiocManager::install("edgeR")

# Paquete ff versión 2.2.0: (en el portatil la 2.2.14 funciona, en el sobremesa no)
# remove.packages("ff")
install.packages("https://cran.r-project.org/src/contrib/Archive/ff/ff_2.2-0.tar.gz", 
                 repos=NULL, type = "source")

# Paquete RSQLite versión 2.1.4:
install.packages("https://cran.r-project.org/src/contrib/Archive/RSQLite/RSQLite_2.1.4.tar.gz",
                 repos=NULL, type = "source")
```


<br>
https://gist.github.com/jdblischak/11384914

Comenzamos cargando `oligo`, `edgeR` y paquetes accesorios:

```{r carga librerias, message = F}
library("oligo")
library("edgeR")
library("ggplot2")
library("dplyr") 
library("FactoMineR") # PCA
library("rgl") # 3D plots
library("Rtsne") # t-SNE
library("uwot") # UMAP
```

<br>

Acto seguido definimos el directorio de trabajo en la carpeta donde se encuentran los archivos de secuenciado.

```{r}
directorio_trabajo <- "../Archivos secuenciado/"
```


Cargamos los archivos de secuenciado en el objeto `datos_crudos_microarrays`.

```{r}
# Obtenemos la ruta completa de los archivos con el argumento `full.names = T`
ruta_completa_archivos_secuenciado <- list.files(path = directorio_trabajo, pattern = "*.CEL", full.names = T)

# Cargamos datos
datos_crudos_microarrays <- read.celfiles(filenames = ruta_completa_archivos_secuenciado)
```


Cambiamos sus nombres por otros más claros:

```{r}
sampleNames(datos_crudos_microarrays) <- c("Control_1", "Genisteina_1",
                                           "Control_2", "Genisteina_2",
                                           "Control_3", "Genisteina_3",
                                           "Control_4", "Genisteina_4")
sampleNames(datos_crudos_microarrays)
```

<br>

Obtenemos la matriz cruda de intensidades:

```{r}
intensidades <- oligo::exprs(datos_crudos_microarrays)
```


<br>


En relación a lo dicho en el párrafo anterior, las gráficas que generemos a lo largo del protocolo de análisis pueden usar información ubicada en el bolsillo `datos_crudos_microarrays@phenoData@data`, por lo que podemos añadir metadatos de interés con el comando `pData()` de `Biobase` tal que así:

```{r}
# Renombramos la columna "index" a "muestra"
colnames(pData(datos_crudos_microarrays)) <- "muestra"

# Añadimos el factor "Condición" a los metadatos de nuestro estudio
pData(datos_crudos_microarrays)$condicion <- as.factor(rep(c("Control", "Genisteina"), times = 4))

# Visualizamos los metadatos
pData(datos_crudos_microarrays)
```




<br>

***


## Comprobación del normalizado: Boxplots

Podemos comparar los datos antes y después del normalizado y control de ruido técnico. Observamos que las intensidades medianas y los cuartiles 25-75 son idénticos entre todos los microarrays tras el normalizado, cosa que no era cierta en los datos crudos:

```{r}
par(mfcol = c(1,2))

boxplot(datos_crudos_microarrays, "all", 
        main = "Antes", col = rainbow(8), 
        ylab = "intensidad sondas (log2)")

boxplot(intensidades2, main = "Después",
        col = rainbow(8), ylab = "intensidad sondas (log2)")
```



```{r}
cpm_log <- cpm(intensidades, log = TRUE)
median_log2_cpm <- apply(cpm_log, 1, median)
hist(median_log2_cpm)
expr_cutoff <- -1
abline(v = expr_cutoff, col = "red", lwd = 3)


intensidades2 <- intensidades[median_log2_cpm > expr_cutoff, ]

cpm_log <- cpm(intensidades2, log = TRUE)
```



<br>

***

# Análisis DEG


## `edgeR`: Análisis de 2 grupos de datos no pareados


Ahora creamos un objeto de tipo `DGEList`, el cual usa `edgeR` para almacenar la información de nuestro experimento de RNA-Seq.


```{r}
y <- DGEList(counts = intensidades, group = pData(datos_crudos_microarrays)$condicion)
```


edgeR normalizes the genes counts using the method TMM (trimmed means of m values) developed by Robinson and Oshlack (2010). Recall from lecture that the read counts for moderately to lowly expressed genes can be strongly influenced by small fluctuations in the expression level of highly expressed genes. In other words, small differences in expression of highly expressed genes between samples can give the appearance that many lower expressed genes are differentially expressed between conditions. TMM adjusts for this by removing the extremely lowly and highly expressed genes and also those genes that are very different across samples. It then compares the total counts for this subset of genes between the two samples to get the scaling factor (this is a simplification). Similar to normalization methods for microarray data, this method assumes the majority of genes are not differentially expressed between any two samples.


```{r}
y <- calcNormFactors(y)
y$samples
```



The next step is to model the variance of the read counts per gene. A natural method for modeling gene counts is the Poisson distribution. However, the Poisson assumes the mean and variance are identical, but it has been found empirically that the variance in RNA-seq measurements of gene expression are larger than the mean (termed “overdispersion”). So instead the negative binomial distribution is used, which has a dispersion parameter for modeling the increase in variance from a Poisson process. edgeR treats the Poisson variance as simple sampling variance, and refers to the dispersion estimate as the “biological coefficient of variation.” Though it should be mentioned that any technical biases are also included in this estimate. edgeR shares information across genes to determine a common dispersion. It extends this to a trended dispersion to model the mean-variance relationship (lowly expressed genes are typically more noisy). Lastly it calculates a dispersion estimate per gene and shrinks it towards the trended dispersion. The gene-specific (referred to in edgeR as tagwise) dispersion estimates are used in the test for differential expression.

```{r}
y <- estimateDisp(y)
sqrt(y$common.dispersion) # biological coefficient of variation
plotBCV(y)
```






The biological coefficient of variation is lower than normally seen in human studies (~0.4) because the samples are technical replicates.

edgeR tests for differential expression between two classes using a method similar in idea to the Fisher’s Exact Test.




```{r}
et <- exactTest(y)
results_edgeR <- topTags(et, n = nrow(intensidades), sort.by = "none")
head(results_edgeR$table)
```




How many genes are differentially expressed at an p-valor del 5%?

```{r}
sum(results_edgeR$table$PValue < .05)

plotSmear(et, de.tags = rownames(results_edgeR)[results_edgeR$table$PValue < .1])
abline(h = c(-2, 2), col = "blue")
```




<br>

***

# Resultados análisis DEG

Tras realizar el t-test moderado, se grafican los resultados en un volcano plot. El volcano plot muestra en el eje X el log<sub>2</sub>FC entre dos grupos (_i.e._ impacto biológico del cambio) y en el eje Y mide el p-valor del cambio (_i.e._ la evidencia estadística de los resultados). En nuestro caso resaltaremos las regiones del gráfico cuyos genes tengan simultáneamente un p-valor < 0.05 y un FC > |2| (cuadrantes superiores derecho e izquierdo):

```{r}
volcanoplot(t_test_bayes, highlight = 0); abline(h = 1.301, v = c(-1,1), lty = 2)
```


Nótese que el parámetro `coef` del comando `volcanoplot()` te permite seleccionar la comparación a graficar (disponible en el bolsillo `t_test_bayes$coefficients`), pero en nuestro caso sólo hemos hecho una comparación (Genisteína vs Control), por lo que lo dejamos con su valor por defecto.



<br>

Tras analizar las regiones de interés del volcano plot, vemos que hay genes candidatos a estar diferencialmente expresados. Vamos a reunir todos los genes detectados en los microarrays en un dataframe y ordenarlos en función de su p-valor no ajustado mediante el comando `topTable`: 

```{r}
df_DEG = topTable(t_test_bayes ,coef = 1 ,number = 138745, adjust.method ="BH", sort.by = "p")
head(df_DEG)
```




<br>

Ahora procedemos a seleccionar sólo los genes que caen en los cuadrantes de interés del volcano plot (p-valor no ajustado < 0.05 y log<sub>2</sub>FC > |1|) y los guardamos en el dataframe `DEG_limma`: 

```{r}
genes_diferencialmente_expresados <- which(df_DEG$P.Value <= 0.05 & abs(df_DEG$logFC) >= 1)
DEG_limma <- df_DEG[genes_diferencialmente_expresados,]
length(genes_diferencialmente_expresados)
```




<br>

Vemos que hemos detectado 204 genes con un p-valor no ajustado < 0.05 y con un ratio de sobre/infraexpresión mayor o igual a 2. Ahora procedemos a separarlos en función de si están sobre o infraexpresados respecto a las muestras control:


```{r}
sobreexpresados <- DEG_limma[DEG_limma[,"logFC"] > 1,]
nrow(sobreexpresados)
head(sobreexpresados)

infraexpresados <- DEG_limma[DEG_limma[,"logFC"] < -1  ,]
nrow(infraexpresados)
head(infraexpresados)
```




<br>

En vista del output del chunk, vemos que tratar las muestras con genisteína provoca la sobreexpresión de 193 genes y la infraexpresión de 11 genes, todos ellos con un ratio de 2 (o sea, el gen TC1100007696.hg.1 está el doble de expresado en las muestras tratadas respecto de las muestras control, mientras que el gen TC1900009657.hg.1 está la mitad de expresado en las muestras tratadas respecto de las muestras control).

Para finalizar este protocolo, procedemos a guardar en archivos de texto la lista total de genes diferencialmente expresados, los genes sobreexpresados y los infraexpresados para poder realizar más tarde los análisis pertinentes (_i.e._ GEA, GSEA, dianas de miRNA...):


```{r, eval = F}
# DEG_limma <- as.vector(DEG_limma)
# Lista total de genes diferencialmente expresados
write.table(x = rownames(DEG_limma), file = "./Resultados DEG/DEG_total_limma.txt", quote = F, 
            row.names = F, col.names = F)

# Genes sobreexpresados
write.table(x = rownames(sobreexpresados), file = "./Resultados DEG/sobreexpresados_limma.txt", quote = F, 
            row.names = F, col.names = F)

# Genes infraexpresados
write.table(x = rownames(infraexpresados), file = "./Resultados DEG/infraexpresados_limma.txt", quote = F, 
            row.names = F, col.names = F)
```


A modo de _addendum_, comentar que hemos guardado los genes con los nombres de los _transcription clusters_. si queremos saber el nombre oficial de los genes (en caso de que lo tengan), debemos traducirlos mediante el ya mencionado portal NetAffx o bien consultando el archivo accesorio `Anotaciones Genes NetAffx.tsv`.



<br>

***

# Bibliografía

* Robinson MD, McCarthy DJ and Smyth GK (2010). edgeR: a Bioconductor package for differential expression analysis of digital gene
  expression data. Bioinformatics 26, 139-140

* McCarthy DJ, Chen Y and Smyth GK (2012). Differential expression analysis of multifactor RNA-Seq experiments with respect to biological
  variation. Nucleic Acids Research 40, 4288-4297

* https://www.thermofisher.com/es/es/home/life-science/microarray-analysis/microarray-data-analysis.html

* https://www.affymetrix.com/support/help/exon_glossary/index.jsp#clusteroverview

* https://www.affymetrix.com/analysis/netaffx

* http://bioconductor.org/packages/release/bioc/vignettes/oligo/inst/doc/oug.pdf

* R. M. Flight, A. M. Eteleeb and E. C. Rouchka, "Affymetrix® Mismatch (MM) Probes: Useful after All," 2012 ASE/IEEE International Conference on BioMedical Computing (BioMedCom), 2012, pp. 6-13, doi: 10.1109/BioMedCom.2012.8.








<br>

***

# sessionInfo()

```{r, echo = F}
sessionInfo()
```



